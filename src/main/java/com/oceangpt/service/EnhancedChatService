package com.oceangpt.service;

import com.oceangpt.agent.AgentOrchestrator;
import com.oceangpt.dto.*;
import com.oceangpt.entity.ChatMessage;
import com.oceangpt.repository.ChatMessageRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * å¢å¼ºçš„èŠå¤©æœåŠ¡
 * æ›´å¥½åœ°æ•´åˆå››ä¸ªæ ¸å¿ƒæ¨¡å—ï¼šèŠå¤©ã€é¢„æµ‹ã€å«æ˜Ÿæ•°æ®ã€æŠ¥å‘Šç”Ÿæˆ
 */
@Service
public class EnhancedChatService {
    
    private static final Logger logger = LoggerFactory.getLogger(EnhancedChatService.class);
    
    @Autowired
    private ChatMessageRepository chatMessageRepository;
    
    @Autowired
    private ParameterMappingService parameterMappingService;
    
    @Autowired
    private CustomModelService customModelService;
    
    @Autowired
    private ReportGenerationService reportGenerationService;
    
    @Autowired
    private DataInterpolationService dataInterpolationService;
    
    @Autowired
    private SatelliteDataService satelliteDataService;
    
    @Autowired
    private InferenceService inferenceService;
    
    @Autowired
    private AgentOrchestrator agentOrchestrator;
    
    // åæ ‡è§£ææ­£åˆ™è¡¨è¾¾å¼
    private static final Pattern COORDINATE_PATTERN = Pattern.compile(
        "(?:çº¬åº¦|åŒ—çº¬|å—çº¬|lat|latitude)?\\s*[ï¼š:]?\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*[åº¦Â°]?\\s*[,ï¼Œ]?\\s*" +
        "(?:ç»åº¦|ä¸œç»|è¥¿ç»|lon|longitude)?\\s*[ï¼š:]?\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*[åº¦Â°]?",
        Pattern.CASE_INSENSITIVE
    );
    
    private static final Pattern BRACKET_COORDINATE_PATTERN = Pattern.compile(
        "\\(\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*[,ï¼Œ]\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*\\)",
        Pattern.CASE_INSENSITIVE
    );
    
    /**
     * å¤„ç†ç”¨æˆ·æ¶ˆæ¯çš„ä¸»å…¥å£
     */
    public ChatResponse processMessage(String sessionId, String message, String userId) {
        logger.info("å¤„ç†ç”¨æˆ·æ¶ˆæ¯: sessionId={}, userId={}, message={}", sessionId, userId, message);
        
        try {
            // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
            saveMessage(sessionId, message, userId, "USER");
            
            // åˆ†ææ¶ˆæ¯æ„å›¾
            MessageIntent intent = analyzeMessageIntent(message);
            logger.info("è¯†åˆ«åˆ°æ¶ˆæ¯æ„å›¾: {}", intent.getType());
            
            ChatResponse response;
            
            switch (intent.getType()) {
                case WATER_QUALITY_PREDICTION:
                case REPORT_REQUEST:
                    // ä½¿ç”¨AgentOrchestratorç»Ÿä¸€å¤„ç†é¢„æµ‹å’ŒæŠ¥å‘Šè¯·æ±‚
                    response = handleAgentRequest(sessionId, message, userId, intent);
                    break;
                case DATA_INQUIRY:
                    response = handleDataInquiry(sessionId, message, intent);
                    break;
                case SYSTEM_STATUS:
                    response = handleSystemStatus(sessionId, message);
                    break;
                default:
                    // ä¸€èˆ¬èŠå¤©ä¹Ÿä½¿ç”¨AgentOrchestratorï¼ˆå…·å¤‡RAGèƒ½åŠ›ï¼‰
                    response = handleAgentRequest(sessionId, message, userId, intent);
                    break;
            }
            
            // ä¿å­˜ç³»ç»Ÿå›å¤
            saveMessage(sessionId, response.getMessage(), "SYSTEM", "ASSISTANT");
            
            return response;
            
        } catch (Exception e) {
            logger.error("å¤„ç†æ¶ˆæ¯å¤±è´¥: {}", e.getMessage(), e);
            return createErrorResponse("å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
    }
    
    /**
     * ä½¿ç”¨AgentOrchestratorå¤„ç†è¯·æ±‚
     */
    private ChatResponse handleAgentRequest(String sessionId, String message, String userId, MessageIntent intent) {
        try {
            ChatRequest request = new ChatRequest();
            request.setSessionId(sessionId);
            request.setMessage(message);
            request.setUserId(userId);
            
            // å¦‚æœIntentä¸­è§£æå‡ºäº†åæ ‡ï¼Œè®¾ç½®åˆ°è¯·æ±‚ä¸­
            if (intent.getCoordinates() != null) {
                double[] coords = intent.getCoordinates();
                request.setLocation(new ChatRequest.LocationInfo(coords[0], coords[1], null));
            }
            
            logger.info("è°ƒç”¨AgentOrchestratorå¤„ç†è¯·æ±‚: sessionId={}", sessionId);
            return agentOrchestrator.run(request);
        } catch (Exception e) {
            logger.error("Agentå¤„ç†å¤±è´¥: {}", e.getMessage(), e);
            return createErrorResponse("æ™ºèƒ½åŠ©æ‰‹å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage());
        }
    }
    
    /**
     * åˆ†ææ¶ˆæ¯æ„å›¾
     */
    private MessageIntent analyzeMessageIntent(String message) {
        String lowerMessage = message.toLowerCase();
        MessageIntent intent = new MessageIntent();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ°´è´¨é¢„æµ‹è¯·æ±‚
        if (isPredictionRequest(message)) {
            intent.setType(MessageIntent.IntentType.WATER_QUALITY_PREDICTION);
            intent.setCoordinates(extractCoordinates(message));
            intent.setDateTime(extractDateTime(message));
            return intent;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æŠ¥å‘Šè¯·æ±‚
        if (isReportRequest(message)) {
            intent.setType(MessageIntent.IntentType.REPORT_REQUEST);
            intent.setReportId(extractReportId(message));
            return intent;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®æŸ¥è¯¢
        if (isDataInquiry(message)) {
            intent.setType(MessageIntent.IntentType.DATA_INQUIRY);
            intent.setCoordinates(extractCoordinates(message));
            return intent;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢
        if (isSystemStatusQuery(message)) {
            intent.setType(MessageIntent.IntentType.SYSTEM_STATUS);
            return intent;
        }
        
        // é»˜è®¤ä¸ºä¸€èˆ¬èŠå¤©
        intent.setType(MessageIntent.IntentType.GENERAL_CHAT);
        return intent;
    }
    
    /**
     * å¤„ç†æ°´è´¨é¢„æµ‹è¯·æ±‚
     */
    private ChatResponse handleWaterQualityPrediction(String sessionId, String message, MessageIntent intent) {
        try {
            double[] coordinates = intent.getCoordinates();
            if (coordinates == null) {
                return createErrorResponse("æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ä»æ‚¨çš„æ¶ˆæ¯ä¸­è¯†åˆ«å‡ºæœ‰æ•ˆçš„ç»çº¬åº¦åæ ‡ã€‚è¯·æä¾›æ ¼å¼å¦‚ 'åŒ—çº¬39åº¦ï¼Œä¸œç»119åº¦' æˆ– '(39.0, 119.0)' çš„åæ ‡ä¿¡æ¯ã€‚");
            }
            
            double latitude = coordinates[0];
            double longitude = coordinates[1];
            LocalDateTime dateTime = intent.getDateTime() != null ? intent.getDateTime() : LocalDateTime.now();
            
            logger.info("å¼€å§‹æ°´è´¨é¢„æµ‹: çº¬åº¦={}, ç»åº¦={}, æ—¶é—´={}", latitude, longitude, dateTime);
            
            // ç¬¬ä¸€æ­¥ï¼šè·å–å«æ˜Ÿæ•°æ®
            ChatResponse.Builder responseBuilder = new ChatResponse.Builder();
            responseBuilder.addStep("ğŸ›°ï¸ æ­£åœ¨è·å–å«æ˜Ÿæ•°æ®...");
            
            SatelliteDataResponse satelliteData = satelliteDataService.getSatelliteData(
                latitude, longitude, dateTime);
            
            if (satelliteData == null || !satelliteData.isSuccess()) {
                return createErrorResponse("æ— æ³•è·å–æŒ‡å®šä½ç½®çš„å«æ˜Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥åæ ‡æ˜¯å¦æ­£ç¡®ã€‚");
            }
            
            responseBuilder.addStep(String.format("âœ… å«æ˜Ÿæ•°æ®è·å–æˆåŠŸ (æ•°æ®æº: %s, è´¨é‡è¯„åˆ†: %.2f)", 
                satelliteData.getDataSource(), satelliteData.getQualityScore()));
            
            // ç¬¬äºŒæ­¥ï¼šå‚æ•°æ˜ å°„
            responseBuilder.addStep("ğŸ”„ æ­£åœ¨è¿›è¡Œå‚æ•°æ˜ å°„...");
            
            Map<String, Object> fastParams = new HashMap<>();
            fastParams.put("fast", true);
            fastParams.put("skipInterpolation", true);
            fastParams.put("skipRegionalAverage", true);
            fastParams.put("gridResolutionDeg", 0.1);
            PredictionRequest predictionRequest = parameterMappingService.mapUserInputToPredictionRequest(
                latitude, longitude, dateTime, fastParams);
            
            if (predictionRequest == null) {
                return createErrorResponse("å‚æ•°æ˜ å°„å¤±è´¥ï¼Œæ— æ³•æ„å»ºé¢„æµ‹è¯·æ±‚ã€‚");
            }
            
            responseBuilder.addStep("âœ… å‚æ•°æ˜ å°„å®Œæˆ");
            
            // ç¬¬ä¸‰æ­¥ï¼šæ¨¡å‹é¢„æµ‹
            responseBuilder.addStep("ğŸ¤– æ­£åœ¨æ‰§è¡ŒAIæ¨¡å‹é¢„æµ‹...");
            
            PredictionResponse predictionResponse = customModelService.predictWaterQuality(predictionRequest);
            
            if (predictionResponse == null || !predictionResponse.isSuccess()) {
                return createErrorResponse("æ¨¡å‹é¢„æµ‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
            }
            
            responseBuilder.addStep("âœ… æ¨¡å‹é¢„æµ‹å®Œæˆ");
            
            // ç¬¬å››æ­¥ï¼šç”ŸæˆæŠ¥å‘Š (æš‚æ—¶æ³¨é‡Šæ‰)
            responseBuilder.addStep("ğŸ“Š æ­£åœ¨ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š...");
            
            // TODO: ä¿®å¤ReportGenerationService.generateReportæ–¹æ³•
            // String reportId = reportGenerationService.generateReport(
            //     predictionRequest, predictionResponse, satelliteData);
            String reportId = "temp_report_" + System.currentTimeMillis();
            
            responseBuilder.addStep("âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ");
            
            // æ„å»ºå®Œæ•´å“åº”
            StringBuilder finalMessage = new StringBuilder();
            finalMessage.append("ğŸŒŠ **æµ·æ´‹æ°´è´¨é¢„æµ‹ç»“æœ**\n\n");
            finalMessage.append(String.format("ğŸ“ **ä½ç½®**: åŒ—çº¬%.4fÂ°, ä¸œç»%.4fÂ°\n", latitude, longitude));
            finalMessage.append(String.format("ğŸ• **æ—¶é—´**: %s\n\n", dateTime.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"))));
            
            finalMessage.append("ğŸ“ˆ **é¢„æµ‹ç»“æœ**:\n");
            finalMessage.append(String.format("- DIN (æº¶è§£æ— æœºæ°®): %.3f mg/L\n", predictionResponse.getDinLevel()));
            finalMessage.append(String.format("- SRP (å¯æº¶æ€§æ´»æ€§ç£·): %.3f mg/L\n", predictionResponse.getSrpLevel()));
            finalMessage.append(String.format("- pHå€¼: %.2f\n", predictionResponse.getPh()));
            finalMessage.append(String.format("- æ°´è´¨ç­‰çº§: %s\n\n", predictionResponse.getQualityLevel()));
            
            finalMessage.append(String.format("ğŸ¯ **ç½®ä¿¡åº¦**: %.1f%%\n\n", predictionResponse.getConfidence() * 100));
            
            finalMessage.append(String.format("ğŸ“‹ **è¯¦ç»†æŠ¥å‘ŠID**: `%s`\n", reportId));
            finalMessage.append("ğŸ’¡ æ‚¨å¯ä»¥è¯´ 'æŸ¥çœ‹æŠ¥å‘Š " + reportId + "' æ¥è·å–å®Œæ•´çš„åˆ†ææŠ¥å‘Šã€‚\n\n");
            
            finalMessage.append("ğŸ” **æ•°æ®æ¥æº**: " + satelliteData.getDataSource() + "\n");
            finalMessage.append(String.format("â±ï¸ **å¤„ç†æ—¶é—´**: %dæ¯«ç§’", predictionResponse.getProcessingTimeMs()));
            
            ChatResponse response = responseBuilder
                .setMessage(finalMessage.toString())
                .setSuccess(true)
                .addData("predictionResult", predictionResponse)
                .addData("reportId", reportId)
                .addData("satelliteData", satelliteData)
                .build();
            
            return response;
            
        } catch (Exception e) {
            logger.error("æ°´è´¨é¢„æµ‹å¤„ç†å¤±è´¥: {}", e.getMessage(), e);
            return createErrorResponse("é¢„æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + e.getMessage());
        }
    }
    
    /**
     * å¤„ç†æŠ¥å‘Šè¯·æ±‚
     */
    private ChatResponse handleReportRequest(String sessionId, String message, MessageIntent intent) {
        try {
            String reportId = intent.getReportId();
            if (reportId == null || reportId.trim().isEmpty()) {
                return createErrorResponse("è¯·æä¾›æœ‰æ•ˆçš„æŠ¥å‘ŠIDï¼Œä¾‹å¦‚ï¼š'æŸ¥çœ‹æŠ¥å‘Š RPT-20240315-001'");
            }
            
            logger.info("è·å–æŠ¥å‘Š: {}", reportId);
            
            // TODO: ä¿®å¤ReportGenerationService.getReportæ–¹æ³•
            // String report = reportGenerationService.getReport(reportId);
            String report = "æŠ¥å‘ŠåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œæ­£åœ¨ç»´æŠ¤ä¸­ã€‚æŠ¥å‘ŠID: " + reportId;
            if (report == null) {
                return createErrorResponse("æœªæ‰¾åˆ°æŠ¥å‘ŠIDä¸º '" + reportId + "' çš„æŠ¥å‘Šã€‚è¯·æ£€æŸ¥æŠ¥å‘ŠIDæ˜¯å¦æ­£ç¡®ã€‚");
            }
            
            ChatResponse response = new ChatResponse();
            response.setSuccess(true);
            response.setMessage("ğŸ“Š **è¯¦ç»†åˆ†ææŠ¥å‘Š**\n\n" + report);
            response.addData("reportId", reportId);
            response.addData("reportContent", report);
            
            return response;
            
        } catch (Exception e) {
            logger.error("æŠ¥å‘Šè·å–å¤±è´¥: {}", e.getMessage(), e);
            return createErrorResponse("è·å–æŠ¥å‘Šæ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage());
        }
    }
    
    /**
     * å¤„ç†æ•°æ®æŸ¥è¯¢
     */
    private ChatResponse handleDataInquiry(String sessionId, String message, MessageIntent intent) {
        try {
            double[] coordinates = intent.getCoordinates();
            if (coordinates == null) {
                return createErrorResponse("è¯·æä¾›æœ‰æ•ˆçš„åæ ‡ä¿¡æ¯è¿›è¡Œæ•°æ®æŸ¥è¯¢ã€‚");
            }
            
            double latitude = coordinates[0];
            double longitude = coordinates[1];
            LocalDateTime dateTime = LocalDateTime.now();
            
            SatelliteDataResponse satelliteData = dataInterpolationService.getInterpolatedSatelliteData(
                latitude, longitude, dateTime);
            
            if (satelliteData == null || !satelliteData.isSuccess()) {
                return createErrorResponse("æ— æ³•è·å–æŒ‡å®šä½ç½®çš„å«æ˜Ÿæ•°æ®ã€‚");
            }
            
            StringBuilder response = new StringBuilder();
            response.append("ğŸ›°ï¸ **å«æ˜Ÿæ•°æ®æŸ¥è¯¢ç»“æœ**\n\n");
            response.append(String.format("ğŸ“ **ä½ç½®**: åŒ—çº¬%.4fÂ°, ä¸œç»%.4fÂ°\n", latitude, longitude));
            response.append(String.format("ğŸ• **æ—¶é—´**: %s\n", dateTime.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"))));
            response.append(String.format("ğŸ“Š **æ•°æ®æº**: %s\n", satelliteData.getDataSource()));
            response.append(String.format("â­ **è´¨é‡è¯„åˆ†**: %.2f\n\n", satelliteData.getQualityScore()));
            
            response.append("ğŸ”¬ **å…‰è°±æ•°æ®**:\n");
            if (satelliteData.getS2Data() != null) {
                response.append("- Sentinel-2: ").append(satelliteData.getS2Data().size()).append(" ä¸ªæ³¢æ®µ\n");
            }
            if (satelliteData.getS3Data() != null) {
                response.append("- Sentinel-3: ").append(satelliteData.getS3Data().size()).append(" ä¸ªæ³¢æ®µ\n");
            }
            
            response.append("\nğŸ§ª **é¢„å¤„ç†ç»“æœ**:\n");
            response.append(String.format("- å¶ç»¿ç´ æµ“åº¦ (ChlNN): %.3f mg/mÂ³\n", satelliteData.getChlNN()));
            response.append(String.format("- æ€»æ‚¬æµ®ç‰© (TsmNN): %.3f mg/L\n", satelliteData.getTsmNN()));
            
            ChatResponse chatResponse = new ChatResponse();
            chatResponse.setSuccess(true);
            chatResponse.setMessage(response.toString());
            chatResponse.addData("satelliteData", satelliteData);
            
            return chatResponse;
            
        } catch (Exception e) {
            logger.error("æ•°æ®æŸ¥è¯¢å¤±è´¥: {}", e.getMessage(), e);
            return createErrorResponse("æ•°æ®æŸ¥è¯¢æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage());
        }
    }
    
    /**
     * å¤„ç†ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢
     */
    private ChatResponse handleSystemStatus(String sessionId, String message) {
        try {
            StringBuilder status = new StringBuilder();
            status.append("ğŸ–¥ï¸ **ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š**\n\n");
            
            // æ£€æŸ¥å„ä¸ªæœåŠ¡çŠ¶æ€
            status.append("ğŸ“¡ **æœåŠ¡çŠ¶æ€**:\n");
            status.append("- èŠå¤©æœåŠ¡: âœ… æ­£å¸¸\n");
            status.append("- å«æ˜Ÿæ•°æ®æœåŠ¡: âœ… æ­£å¸¸\n");
            status.append("- é¢„æµ‹æ¨¡å‹æœåŠ¡: âœ… æ­£å¸¸\n");
            status.append("- æŠ¥å‘Šç”ŸæˆæœåŠ¡: âœ… æ­£å¸¸\n\n");
            
            status.append("ğŸ”§ **åŠŸèƒ½æ¨¡å—**:\n");
            status.append("- æ™ºèƒ½å¯¹è¯: âœ… å¯ç”¨\n");
            status.append("- æ°´è´¨é¢„æµ‹: âœ… å¯ç”¨\n");
            status.append("- æ•°æ®æ’å€¼: âœ… å¯ç”¨\n");
            status.append("- æŠ¥å‘Šç”Ÿæˆ: âœ… å¯ç”¨\n\n");
            
            status.append("ğŸ“Š **æ•°æ®è¦†ç›–**:\n");
            status.append("- å…¨çƒæµ·åŸŸ: âœ… æ”¯æŒ\n");
            status.append("- å®æ—¶æ•°æ®: âœ… æ”¯æŒ\n");
            status.append("- å†å²æ•°æ®: âœ… æ”¯æŒ\n");
            status.append("- æ•°æ®æ’å€¼: âœ… æ”¯æŒ\n\n");
            
            status.append("ğŸ’¡ **ä½¿ç”¨æç¤º**:\n");
            status.append("- è¾“å…¥åæ ‡è¿›è¡Œæ°´è´¨é¢„æµ‹\n");
            status.append("- æŸ¥çœ‹ç”Ÿæˆçš„è¯¦ç»†æŠ¥å‘Š\n");
            status.append("- æŸ¥è¯¢ç‰¹å®šä½ç½®çš„å«æ˜Ÿæ•°æ®\n");
            
            ChatResponse response = new ChatResponse();
            response.setSuccess(true);
            response.setMessage(status.toString());
            
            return response;
            
        } catch (Exception e) {
            logger.error("ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢å¤±è´¥: {}", e.getMessage(), e);
            return createErrorResponse("ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage());
        }
    }
    
    /**
     * å¤„ç†ä¸€èˆ¬èŠå¤©
     */
    private ChatResponse handleGeneralChat(String sessionId, String message) {
        StringBuilder response = new StringBuilder();
        response.append("ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯OceanGPTæµ·æ´‹æ°´è´¨ç›‘æµ‹åŠ©æ‰‹ã€‚\n\n");
        response.append("ğŸŒŠ **æˆ‘å¯ä»¥å¸®æ‚¨**:\n");
        response.append("- ğŸ” é¢„æµ‹ä»»æ„æµ·åŸŸçš„æ°´è´¨æƒ…å†µ\n");
        response.append("- ğŸ“Š ç”Ÿæˆè¯¦ç»†çš„æ°´è´¨åˆ†ææŠ¥å‘Š\n");
        response.append("- ğŸ›°ï¸ æŸ¥è¯¢å«æ˜Ÿé¥æ„Ÿæ•°æ®\n");
        response.append("- ğŸ“ˆ åˆ†ææ°´è´¨å˜åŒ–è¶‹åŠ¿\n\n");
        
        response.append("ğŸ’¡ **ä½¿ç”¨ç¤ºä¾‹**:\n");
        response.append("- \"é¢„æµ‹åŒ—çº¬39åº¦ï¼Œä¸œç»119åº¦çš„æ°´è´¨\"\n");
        response.append("- \"åˆ†æåæ ‡(38.5, 120.2)çš„æµ·æ°´è´¨é‡\"\n");
        response.append("- \"æŸ¥çœ‹æŠ¥å‘Š RPT-20240315-001\"\n");
        response.append("- \"æŸ¥è¯¢(40.0, 118.0)çš„å«æ˜Ÿæ•°æ®\"\n\n");
        
        response.append("ğŸš€ è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£å“ªä¸ªæµ·åŸŸçš„æ°´è´¨æƒ…å†µï¼");
        
        ChatResponse chatResponse = new ChatResponse();
        chatResponse.setSuccess(true);
        chatResponse.setMessage(response.toString());
        
        return chatResponse;
    }
    
    // è¾…åŠ©æ–¹æ³•
    private boolean isPredictionRequest(String message) {
        String lowerMessage = message.toLowerCase();
        return (lowerMessage.contains("é¢„æµ‹") || lowerMessage.contains("åˆ†æ") || lowerMessage.contains("æ£€æµ‹")) &&
               (lowerMessage.contains("æ°´è´¨") || lowerMessage.contains("æµ·æ°´") || lowerMessage.contains("æµ·æ´‹")) &&
               (extractCoordinates(message) != null);
    }
    
    private boolean isReportRequest(String message) {
        String lowerMessage = message.toLowerCase();
        return (lowerMessage.contains("æŠ¥å‘Š") || lowerMessage.contains("report")) &&
               (lowerMessage.contains("æŸ¥çœ‹") || lowerMessage.contains("è·å–") || lowerMessage.contains("æ˜¾ç¤º"));
    }
    
    private boolean isDataInquiry(String message) {
        String lowerMessage = message.toLowerCase();
        return (lowerMessage.contains("æŸ¥è¯¢") || lowerMessage.contains("æ•°æ®") || lowerMessage.contains("å«æ˜Ÿ")) &&
               (extractCoordinates(message) != null) &&
               !isPredictionRequest(message);
    }
    
    private boolean isSystemStatusQuery(String message) {
        String lowerMessage = message.toLowerCase();
        return lowerMessage.contains("çŠ¶æ€") || lowerMessage.contains("å¥åº·") || lowerMessage.contains("è¿è¡Œ");
    }
    
    private double[] extractCoordinates(String message) {
        // å°è¯•åŒ¹é… "çº¬åº¦: 39.1, ç»åº¦: 117.2" æ ¼å¼
        Matcher matcher = COORDINATE_PATTERN.matcher(message);
        if (matcher.find()) {
            try {
                double lat = Double.parseDouble(matcher.group(1));
                double lon = Double.parseDouble(matcher.group(2));
                return new double[]{lat, lon};
            } catch (NumberFormatException e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
        }
        
        // å°è¯•åŒ¹é… "(39.1, 117.2)" æ ¼å¼
        matcher = BRACKET_COORDINATE_PATTERN.matcher(message);
        if (matcher.find()) {
            try {
                double lat = Double.parseDouble(matcher.group(1));
                double lon = Double.parseDouble(matcher.group(2));
                return new double[]{lat, lon};
            } catch (NumberFormatException e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
        }
        
        return null;
    }
    
    private LocalDateTime extractDateTime(String message) {
        // ç®€å•å®ç°ï¼šæš‚æ—¶åªæ”¯æŒå½“å‰æ—¶é—´
        // æœªæ¥å¯ä»¥æ·»åŠ å¯¹ "æ˜¨å¤©"ã€"2023-01-01" ç­‰æ—¶é—´æè¿°çš„è§£æ
        return LocalDateTime.now();
    }
    
    private String extractReportId(String message) {
        // ç®€å•æå–ï¼Œå‡è®¾æŠ¥å‘ŠIDä»¥ RPT- å¼€å¤´
        Pattern pattern = Pattern.compile("RPT-[\\w-]+");
        Matcher matcher = pattern.matcher(message);
        if (matcher.find()) {
            return matcher.group();
        }
        return null;
    }
    
    private ChatResponse createErrorResponse(String message) {
        ChatResponse response = new ChatResponse();
        response.setSuccess(false);
        response.setErrorMessage(message);
        response.setMessage("âš ï¸ " + message);
        return response;
    }
    
    private void saveMessage(String sessionId, String content, String senderId, String senderType) {
        try {
            ChatMessage chatMessage = new ChatMessage();
            chatMessage.setSessionId(sessionId);
            chatMessage.setContent(content);
            chatMessage.setSenderId(senderId);
            chatMessage.setSenderType(senderType);
            chatMessage.setTimestamp(LocalDateTime.now());
            chatMessageRepository.save(chatMessage);
        } catch (Exception e) {
            logger.error("ä¿å­˜æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
